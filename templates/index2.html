</!DOCTYPE html>
<html>
<head>
	<title>Hello pages</title>
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='lib/css/bootstrap.min.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='lib/css/dc.min.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='main_style.css') }}">
	<script src="{{ url_for('static', 
	filename='lib/js/machine_learning.min.js') }}"></script>
</head>
<body>

<nav class="navbar navbar-inverse">
    <div class="navbar-header">
      <a class="navbar-brand" href="#">AVW DASHBOARD</a>
    </div>
</nav>

 <div class="row">
 	<div class="col-md-5" id=videoRow>
 		<h4>Comments Per Video</h4>
 	</div>
 	<div class="col-md-7" id=commentsPerMinute>
 		<h4>Comments per minute</h4>
 	</div>
 </div>

 <div class="row">
 	<div class="col-md-7" id=clusterBar style="padding: 5em;">
 			<h4>K-Clusters by Cues</h4>
 			<form action="index.html">
 			<input type="number" id="user_k" placeholder="k" style=" width: 3em; height: 2.5em">
 			<button type="button" class="btn btn-info" id="clusterSubmit">Submit</button>
 			</form>
 		</div>
 	</div>
 	<div class="col-md-5" id=clusterSize>
 	</div>
 </div>


<!-- js section -->
<script src="{{ url_for('static', filename='lib/js/d3.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/js/jquery.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/js/crossfilter.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/js/dc.min.js') }}"></script>


<script>
	d3.csv("{{ url_for('static', filename='presentationComments.csv') }}",function(data){


			// initialize number of clusters
			var num_k = 2;

			// Get cuepoint and transform to 2d array for clustering library convenience.
			var cueArray = [];

			var cueClusters = new Array(cueArray.length);
			var result;
			var ndx;

			function make2dCue(cuepoint_value){
				var twoDPad = [0];
				twoDPad.push(cuepoint_value);
				cueArray.push(twoDPad);
			}

			function get_csv_vals(){
				data.forEach(function(d){
					d.COMMENTID = +d.COMMENTID;
					d.CUE = +d.CUE;
					d.VIDEO = d.VIDEO;
					d.TRIMVIDEO = d.TRIMVIDEO;
					make2dCue(d.CUE);
					d.Cuebin = Math.ceil(d.CUE/60); // 60 sec bins
				});
			}// end get_csv_val
			

			// CLUSTERING SEGMENT ================================================================================

			function run_clustering(){
				    result = ml.kmeans.cluster({
					data: cueArray,
					k: num_k,
					init_using_data: true,
					epochs: 500,
					distance: {type:"euclidean"}
				});
			}

			// reshape cue centroids to 1 dimension
			function reshape_cue(){
				for (j=0;j<result.clusters.length;j++){
					for(k=0;k<result.clusters[j].length;k++){
						cueClusters[result.clusters[j][k]] = Math.round(result.means[j][1]);
					}
					}
			}// end reshape_cue


			// add cuepoint clusters to data.
			function add_cue_clusters(){
				var count = 0;
				data.forEach(function(d){
					d.cueGroups = cueClusters[count];
					count = count + 1;
				});
			} // end add_cue_clusters


			// FILTERING AND CHARTING SEGMENT =======================================================================
			function init_crossfilter(){
				ndx = crossfilter(data);
				console.log("Size of dataset is :",ndx.size());
			} // end init_crossfilter

			// Get cuepoint bins as dimension 
			function cue_bin_viz(){
				var timeDim = ndx.dimension(function(d){
					return d.Cuebin;
				});

				var commentsPerCuebin = timeDim.group().reduceCount();
				

				var minCuebin = timeDim.bottom(1)[0].Cuebin;
				var maxCuebin = timeDim.top(1)[0].Cuebin;

				var CommentLineChart = dc.lineChart('#commentsPerMinute');

				CommentLineChart.height(400)
								.width(800)
								.dimension(timeDim)
								.group(commentsPerCuebin)
								.x(d3.scale.linear().domain([minCuebin, maxCuebin]))
								.xAxisLabel('Time (minutes)')
								.yAxisLabel('Number of Comments')
								.elasticY(true)
								.brushOn(false);

			} //end cue_bin_viz


			function video_viz(){
				var videoDim = ndx.dimension(function(d){
					return d.TRIMVIDEO;
				});

				var commentsPerVideo = videoDim.group().reduceCount();



				// row chart
				commentPerVideoRow = dc.rowChart('#VideoRow');
				commentPerVideoRow.width(600)
								  .height(400)
								  .dimension(videoDim)
								  .group(commentsPerVideo)
								  .renderLabel(true)
								  .title('Number of comments')
								  .renderTitleLabel(true)
								  .xAxis('Number of comments');

			} // end video_viz


			// Cluster chart =============================================================================================
			function cluster_viz(){
				var clusterDim = ndx.dimension(function(d){
					return d.cueGroups;
				});
				var commentsPerCluster = clusterDim.group().reduceCount();
				
				clusterBarChart = dc.pieChart('#clusterBar');
				var minClusterMean = clusterDim.bottom(1)[0].cueGroups;
				var maxClusterMean = clusterDim.top(1)[0].cueGroups;
				clusterBarChart.width(300)
							   .height(300)
							   //.x(d3.scale.linear().domain([minClusterMean,maxClusterMean]))
							   .dimension(clusterDim)
							   .group(commentsPerCluster)
							   //.elasticY(true)
			} // end cluster_viz

			function render_charts(){
				dc.renderAll();
			} // end render_charts



			function run_page(){
				get_csv_vals();
				run_clustering();
				reshape_cue();
				add_cue_clusters();
				init_crossfilter();
				cue_bin_viz();
				video_viz();
				cluster_viz();
				render_charts();
			}

			run_page();

			d3.select("#clusterSubmit").on("click",function(){
				num_k = document.getElementById("user_k").value;
				run_page();
				});

	}); // end of csv read 

</script>
</body>
</html>